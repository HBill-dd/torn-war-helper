<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Torn City War Helper</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    input, button { margin: 5px 0; padding: 8px; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #999; padding: 10px; text-align: left; }
    th { background-color: #f2f2f2; }
    .error { color: red; margin-top: 10px; }
    .status-online  { color: green; font-weight: bold; }
    .status-idle    { color: orange; font-weight: bold; }
    .status-offline { color: gray; font-weight: bold; }
  </style>
</head>
<body>

  <h2>War Helper</h2>

  <label for="apiKey">Your API Key:</label><br>
  <input type="text" id="apiKey" placeholder="Enter your Torn API Key" size="50"><br>

  <label for="factionId">Target Faction ID:</label><br>
  <input type="text" id="factionId" placeholder="Enter the faction you want to check"><br>

  <button id="fetchBtn" onclick="authorizeAndFetch()">Fetch Members</button>
  <button id="sortBtn" disabled>Sort by Level ‚Üì</button>

  <div id="output"></div>
  <div id="error" class="error"></div>

  <script>
    const allowedFactions = [37803, 789012, 8675309];

    let membersData = [];
    let factionName = '';
    let sortAsc = false;

    document.getElementById('sortBtn').addEventListener('click', () => {
      sortAsc = !sortAsc;
      document.getElementById('sortBtn').textContent =
        sortAsc ? 'Sort by Level ‚Üë' : 'Sort by Level ‚Üì';
      renderTable();
    });

    async function authorizeAndFetch() {
      const apiKey = document.getElementById('apiKey').value.trim();
      const error = document.getElementById('error');
      error.textContent = '';
      document.getElementById('output').innerHTML = '';

      if (!apiKey) {
        error.textContent = '‚ùå API Key is required.';
        return;
      }

      try {
        const userRes = await fetch(`https://api.torn.com/user/?selections=profile&key=${apiKey}`);
        const userData = await userRes.json();

        if (userData.error) {
          error.textContent = `‚ùå Error ${userData.error.code}: ${userData.error.error}`;
          return;
        }

        const userFactionId = userData.faction?.faction_id;
        if (!userFactionId) {
          error.textContent = '‚ùå You are not in a faction.';
          return;
        }

        if (!allowedFactions.includes(userFactionId)) {
          error.textContent = `‚ùå Access denied. Your faction [${userFactionId}] is not authorized to use this tool.`;
          return;
        }

        fetchFactionData(apiKey);

      } catch (e) {
        console.error(e);
        error.textContent = '‚ùå Failed to verify user faction. Check your API key or try again later.';
      }
    }

    async function fetchFactionData(apiKey) {
      const factionId = document.getElementById('factionId').value.trim();
      const output = document.getElementById('output');
      const error = document.getElementById('error');
      output.innerHTML = '';
      error.textContent = '';

      if (!factionId) {
        error.textContent = '‚ùå Please enter the target faction ID.';
        return;
      }

      try {
        const res = await fetch(
          `https://api.torn.com/v2/faction/${factionId}?selections=basic,members,personalstats,criminalrecord&key=${apiKey}`
        );
        const data = await res.json();

        if (data.error) {
          error.textContent = `‚ùå Error ${data.error.code}: ${data.error.error}`;
          return;
        }

        factionName = data.basic.name || '';
        membersData = Object.values(data.members);
        sortAsc = false;
        document.getElementById('sortBtn').textContent = 'Sort by Level ‚Üì';
        document.getElementById('sortBtn').disabled = false;

        renderTable();

      } catch (e) {
        console.error(e);
        error.textContent = '‚ùå Failed to fetch faction data.';
      }
    }

    function parseHospitalMinutes(description) {
      const hourMatch = description.match(/(\d+)\s*hrs?/);
      const minMatch = description.match(/(\d+)\s*mins?/);
      const hours = hourMatch ? parseInt(hourMatch[1]) : 0;
      const mins = minMatch ? parseInt(minMatch[1]) : 0;
      return (hours * 60) + mins;
    }

    function estimateStatRange(member) {
      const rankTriggerMap = {
        "Absolute beginner": 0, "Beginner": 1, "Inexperienced": 2, "Rookie": 3, "Novice": 4,
        "Below Average": 5, "Average": 6, "Reasonable": 7, "Above Average": 8, "Competent": 9,
        "Highly competent": 10, "Veteran": 11, "Distinguished": 12, "Highly distinguished": 13,
        "Professional": 14, "Star": 15, "Master": 16, "Outstanding": 17, "Celebrity": 18,
        "Supreme": 19, "Idolized": 20, "Champion": 21, "Heroic": 22, "Legendary": 23,
        "Elite": 24, "Invincible": 25
      };

      const statTriggerRanges = [
        "Less than 2,500",
        "2,500 to 25,000",
        "25,000 to 250,000",
        "250,000 to 2,500,000",
        "2.5M to 35M",
        "35M to 250M",
        "250M+"
      ];

      const totalTriggers = rankTriggerMap[member.rank] ?? 0;

      const levelTriggers = [2, 6, 11, 26, 31, 50, 71, 100].filter(l => member.level >= l).length;
      const crimeTriggers = [100, 5000, 10000, 20000, 30000, 50000].filter(c => member.criminalrecord?.total >= c).length;
      const networth = member.personalstats?.networth || 0;
      const networthTriggers = [5e6, 5e7, 5e8, 5e9, 5e10].filter(n => networth >= n).length;

      const knownTriggers = levelTriggers + crimeTriggers + networthTriggers;
      const statTriggers = Math.max(0, totalTriggers - knownTriggers);

      return statTriggerRanges[statTriggers] || "Unknown";
    }

    function renderTable() {
      if (!membersData.length) return;

      const hospitalMembers = membersData
        .filter(m => (m.status.description || '').toLowerCase().includes('hospital'))
        .sort((a, b) => {
          const aMin = parseHospitalMinutes(a.status.description || '');
          const bMin = parseHospitalMinutes(b.status.description || '');
          return aMin - bMin;
        });

      const normalMembers = membersData
        .filter(m => !(m.status.description || '').toLowerCase().includes('hospital'))
        .sort((a, b) => sortAsc ? a.level - b.level : b.level - a.level);

      const sortedMembers = hospitalMembers.concat(normalMembers);

      let html = `<h3>üè¥ Faction: ${factionName}</h3>`;
      html += `
        <table>
          <thead>
            <tr>
              <th>Username [ID]</th>
              <th>Level</th>
              <th>Status</th>
              <th>Description</th>
              <th>Range</th>
            </tr>
          </thead>
          <tbody>
      `;

      sortedMembers.forEach(m => {
        const id = m.id;
        const username = `${m.name} [${id}]`;
        const level = m.level;
        const desc = m.status.description || '';
        const statusLabel = m.last_action.status;
        const statusClass = statusLabel === 'Online'
          ? 'status-online'
          : statusLabel === 'Idle'
          ? 'status-idle'
          : 'status-offline';
        const range = estimateStatRange(m);

        html += `
          <tr>
            <td>
              <a href="https://www.torn.com/profiles.php?XID=${id}" target="_blank">
                ${username}
              </a>
            </td>
            <td>${level}</td>
            <td class="${statusClass}">${statusLabel}</td>
            <td>${desc}</td>
            <td>${range}</td>
          </tr>
        `;
      });

      html += `</tbody></table>`;
      document.getElementById('output').innerHTML = html;
    }
  </script>

</body>
</html>
